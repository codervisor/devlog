generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Project management
model Project {
  id             Int      @id @default(autoincrement())
  name           String   @unique
  description    String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  lastAccessedAt DateTime @default(now()) @map("last_accessed_at") @db.Timestamptz

  // Relations
  devlogEntries DevlogEntry[]

  @@map("devlog_projects")
}

// Main devlog entries
model DevlogEntry {
  id                Int         @id @default(autoincrement())
  key               String      @unique @map("key_field")
  title             String     
  type              String      @default("task") // DevlogType as string
  description       String      @db.Text
  status            String      @default("new") // DevlogStatus as string
  priority          String      @default("medium") // DevlogPriority as string
  createdAt         DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime    @updatedAt @map("updated_at") @db.Timestamptz
  closedAt          DateTime?   @map("closed_at") @db.Timestamptz
  archived          Boolean     @default(false)
  assignee          String?    
  projectId         Int         @map("project_id")

  // Flattened DevlogContext fields
  businessContext   String?     @map("business_context") @db.Text
  technicalContext  String?     @map("technical_context") @db.Text
  tags              String?     @db.Text // JSON array as text
  files             String?     @db.Text // JSON array as text
  dependencies      String?     @db.Text // JSON array as text

  // Relations
  project           Project     @relation(fields: [projectId], references: [id])
  notes             DevlogNote[]
  dependencies_from DevlogDependency[] @relation("DevlogDependencySource")
  dependencies_to   DevlogDependency[] @relation("DevlogDependencyTarget")
  documents         DevlogDocument[]
  chatLinks         ChatDevlogLink[]

  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([assignee])
  @@index([key])
  @@index([projectId])
  @@map("devlog_entries")
}

// Devlog notes - separate table for better relational modeling
model DevlogNote {
  id        String            @id
  devlogId  Int               @map("devlog_id")
  timestamp DateTime          @db.Timestamptz
  category  String            // DevlogNoteCategory as string
  content   String            @db.Text

  // Relations
  devlogEntry DevlogEntry @relation(fields: [devlogId], references: [id], onDelete: Cascade)

  @@index([devlogId])
  @@index([timestamp])
  @@index([category])
  @@map("devlog_notes")
}

// Devlog dependencies for hierarchical work management
model DevlogDependency {
  id              String              @id
  devlogId        Int                 @map("devlog_id")
  type            String              // DevlogDependencyType as string
  description     String              @db.Text
  externalId      String?             @map("external_id")
  targetDevlogId  Int?                @map("target_devlog_id")

  // Relations
  devlogEntry       DevlogEntry @relation("DevlogDependencySource", fields: [devlogId], references: [id], onDelete: Cascade)
  targetDevlogEntry DevlogEntry? @relation("DevlogDependencyTarget", fields: [targetDevlogId], references: [id], onDelete: SetNull)

  @@index([devlogId])
  @@index([type])
  @@index([targetDevlogId])
  @@map("devlog_dependencies")
}

// Devlog documents
model DevlogDocument {
  id            String   @id
  devlogId      Int      @map("devlog_id")
  filename      String   // Internal filename/identifier
  originalName  String   @map("original_name") // Original filename from upload
  mimeType      String   @map("mime_type")
  size          Int      // Size in bytes
  type          String   // DocumentType as string (text, markdown, image, pdf, etc.)
  textContent   String?  @map("text_content") @db.Text // Extracted text content for searchable documents
  binaryContent Bytes?   @map("binary_content") // Binary content for files
  metadata      Json     @default("{}") // Additional file metadata
  uploadedBy    String?  @map("uploaded_by") // User who uploaded the document
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  devlogEntry DevlogEntry @relation(fields: [devlogId], references: [id], onDelete: Cascade)

  @@index([devlogId])
  @@index([mimeType])
  @@index([type])
  @@index([originalName])
  @@map("devlog_documents")
}

// User management and authentication
model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique
  name            String?  
  avatarUrl       String?   @map("avatar_url")
  passwordHash    String    @map("password_hash")
  isEmailVerified Boolean   @default(false) @map("is_email_verified")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  lastLoginAt     DateTime? @map("last_login_at") @db.Timestamptz

  // Relations
  providers                   UserProvider[]
  emailVerificationTokens     EmailVerificationToken[]
  passwordResetTokens         PasswordResetToken[]

  @@map("devlog_users")
}

// OAuth providers
model UserProvider {
  id         Int    @id @default(autoincrement())
  userId     Int    @map("user_id")
  provider   String
  providerId String @map("provider_id")
  email      String
  name       String
  avatarUrl  String @map("avatar_url")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("devlog_user_providers")
}

// Email verification tokens
model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  used      Boolean  @default(false)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("devlog_email_verification_tokens")
}

// Password reset tokens
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  used      Boolean  @default(false)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("devlog_password_reset_tokens")
}

// Chat sessions
model ChatSession {
  id            String     @id
  agent         String     // AgentType as string
  timestamp     String // ISO string
  workspace     String?
  workspacePath String?    @map("workspace_path")
  title         String?
  status        String     @default("imported") // ChatStatus as string
  messageCount  Int        @default(0) @map("message_count")
  duration      Int?
  metadata      Json       @default("{}")
  updatedAt     String     @map("updated_at") // ISO string
  archived      Boolean    @default(false)

  // Relations
  messages  ChatMessage[]
  devlogLinks ChatDevlogLink[]

  @@index([agent])
  @@index([timestamp])
  @@index([workspace])
  @@index([status])
  @@index([archived])
  @@map("chat_sessions")
}

// Chat messages
model ChatMessage {
  id            String  @id
  sessionId     String  @map("session_id")
  role          String  // ChatRole as string
  content       String  @db.Text
  timestamp     String // ISO string
  sequence      Int
  metadata      Json    @default("{}")
  searchContent String? @map("search_content") @db.Text

  // Relations
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
  @@index([role])
  @@index([sessionId, sequence])
  @@map("chat_messages")
}

// Chat-devlog links
model ChatDevlogLink {
  id         String   @id
  sessionId  String   @map("session_id")
  devlogId   Int      @map("devlog_id")
  timestamp  DateTime @db.Timestamptz
  linkReason String   @map("link_reason")

  // Relations
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  devlogEntry DevlogEntry @relation(fields: [devlogId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([devlogId])
  @@index([timestamp])
  @@map("chat_devlog_links")
}

// Note: Enums are now handled as strings for flexibility
// TypeScript types and validation provide the constraints
// This reduces type mapping complexity between Prisma and TypeScript