// Prisma schema file
// This is the main schema for the devlog project migrated from TypeORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Project management
model Project {
  id             Int      @id @default(autoincrement())
  name           String   @unique @db.VarChar(255)
  description    String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  lastAccessedAt DateTime @default(now()) @map("last_accessed_at") @db.Timestamptz

  // Relations
  devlogEntries DevlogEntry[]

  @@map("devlog_projects")
}

// Main devlog entries
model DevlogEntry {
  id                Int         @id @default(autoincrement())
  key               String      @unique @map("key_field") @db.VarChar(255)
  title             String      @db.VarChar(500)
  type              DevlogType  @default(task)
  description       String      @db.Text
  status            DevlogStatus @default(new)
  priority          DevlogPriority @default(medium)
  createdAt         DateTime    @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime    @updatedAt @map("updated_at") @db.Timestamptz
  closedAt          DateTime?   @map("closed_at") @db.Timestamptz
  archived          Boolean     @default(false)
  assignee          String?     @db.VarChar(255)
  projectId         Int         @map("project_id")

  // Flattened DevlogContext fields
  businessContext   String?     @map("business_context") @db.Text
  technicalContext  String?     @map("technical_context") @db.Text
  tags              String?     @db.Text // JSON array as text
  files             String?     @db.Text // JSON array as text
  dependencies      String?     @db.Text // JSON array as text

  // Relations
  project           Project     @relation(fields: [projectId], references: [id])
  notes             DevlogNote[]
  dependencies_from DevlogDependency[] @relation("DevlogDependencySource")
  dependencies_to   DevlogDependency[] @relation("DevlogDependencyTarget")
  documents         DevlogDocument[]
  chatLinks         ChatDevlogLink[]

  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([assignee])
  @@index([key])
  @@index([projectId])
  @@map("devlog_entries")
}

// Devlog notes - separate table for better relational modeling
model DevlogNote {
  id        String            @id @db.VarChar(255)
  devlogId  Int               @map("devlog_id")
  timestamp DateTime          @db.Timestamptz
  category  DevlogNoteCategory
  content   String            @db.Text

  // Relations
  devlogEntry DevlogEntry @relation(fields: [devlogId], references: [id], onDelete: Cascade)

  @@index([devlogId])
  @@index([timestamp])
  @@index([category])
  @@map("devlog_notes")
}

// Devlog dependencies for hierarchical work management
model DevlogDependency {
  id              String              @id @db.VarChar(255)
  devlogId        Int                 @map("devlog_id")
  type            DevlogDependencyType
  description     String              @db.Text
  externalId      String?             @map("external_id") @db.VarChar(255)
  targetDevlogId  Int?                @map("target_devlog_id")

  // Relations
  devlogEntry       DevlogEntry @relation("DevlogDependencySource", fields: [devlogId], references: [id], onDelete: Cascade)
  targetDevlogEntry DevlogEntry? @relation("DevlogDependencyTarget", fields: [targetDevlogId], references: [id], onDelete: SetNull)

  @@index([devlogId])
  @@index([type])
  @@index([targetDevlogId])
  @@map("devlog_dependencies")
}

// Devlog documents
model DevlogDocument {
  id          String   @id @db.VarChar(255)
  devlogId    Int      @map("devlog_id")
  title       String   @db.VarChar(500)
  content     String   @db.Text
  contentType String   @map("content_type") @db.VarChar(100)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  devlogEntry DevlogEntry @relation(fields: [devlogId], references: [id], onDelete: Cascade)

  @@index([devlogId])
  @@index([contentType])
  @@map("devlog_documents")
}

// User management and authentication
model User {
  id              Int       @id @default(autoincrement())
  email           String    @unique @db.VarChar(255)
  name            String?   @db.VarChar(255)
  avatarUrl       String?   @map("avatar_url") @db.VarChar(255)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  isEmailVerified Boolean   @default(false) @map("is_email_verified")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  lastLoginAt     DateTime? @map("last_login_at") @db.Timestamptz

  // Relations
  providers                   UserProvider[]
  emailVerificationTokens     EmailVerificationToken[]
  passwordResetTokens         PasswordResetToken[]

  @@map("devlog_users")
}

// OAuth providers
model UserProvider {
  id         Int    @id @default(autoincrement())
  userId     Int    @map("user_id")
  provider   String @db.VarChar(50)
  providerId String @map("provider_id") @db.VarChar(255)
  email      String @db.VarChar(255)
  name       String @db.VarChar(255)
  avatarUrl  String @map("avatar_url") @db.VarChar(500)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@index([userId])
  @@map("devlog_user_providers")
}

// Email verification tokens
model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  used      Boolean  @default(false)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("devlog_email_verification_tokens")
}

// Password reset tokens
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  used      Boolean  @default(false)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("devlog_password_reset_tokens")
}

// Chat sessions
model ChatSession {
  id            String     @id @db.VarChar(255)
  agent         AgentType  @db.VarChar(100)
  timestamp     String     @db.VarChar(255) // ISO string
  workspace     String?    @db.VarChar(500)
  workspacePath String?    @map("workspace_path") @db.VarChar(1000)
  title         String?    @db.VarChar(500)
  status        ChatStatus @default(imported) @db.VarChar(50)
  messageCount  Int        @default(0) @map("message_count")
  duration      Int?
  metadata      Json       @default("{}")
  updatedAt     String     @map("updated_at") @db.VarChar(255) // ISO string
  archived      Boolean    @default(false)

  // Relations
  messages  ChatMessage[]
  devlogLinks ChatDevlogLink[]

  @@index([agent])
  @@index([timestamp])
  @@index([workspace])
  @@index([status])
  @@index([archived])
  @@map("chat_sessions")
}

// Chat messages
model ChatMessage {
  id            String  @id @db.VarChar(255)
  sessionId     String  @map("session_id") @db.VarChar(255)
  role          ChatRole @db.VarChar(20)
  content       String  @db.Text
  timestamp     String  @db.VarChar(255) // ISO string
  sequence      Int
  metadata      Json    @default("{}")
  searchContent String? @map("search_content") @db.Text

  // Relations
  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([timestamp])
  @@index([role])
  @@index([sessionId, sequence])
  @@map("chat_messages")
}

// Chat-devlog links
model ChatDevlogLink {
  id         String   @id @db.VarChar(255)
  sessionId  String   @map("session_id") @db.VarChar(255)
  devlogId   Int      @map("devlog_id")
  timestamp  DateTime @db.Timestamptz
  linkReason String   @map("link_reason") @db.VarChar(500)

  // Relations
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  devlogEntry DevlogEntry @relation(fields: [devlogId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([devlogId])
  @@index([timestamp])
  @@map("chat_devlog_links")
}

// Enums
enum DevlogType {
  feature
  bugfix
  task
  refactor
  docs
}

enum DevlogStatus {
  new          @map("new")
  in_progress  @map("in-progress")
  blocked
  in_review    @map("in-review")
  testing
  done
  cancelled
}

enum DevlogPriority {
  low
  medium
  high
  critical
}

enum DevlogNoteCategory {
  progress
  issue
  solution
  idea
  reminder
  feedback
  acceptance_criteria @map("acceptance-criteria")
}

enum DevlogDependencyType {
  blocks
  blocked_by  @map("blocked-by")
  related_to  @map("related-to")
  parent_of   @map("parent-of")
  child_of    @map("child-of")
}

enum AgentType {
  anthropic_claude
  openai_gpt
  google_gemini
  github_copilot
  cursor
  vscode_copilot
  jetbrains_ai
  unknown
}

enum ChatStatus {
  imported
  linked
  processed
  archived
}

enum ChatRole {
  user
  assistant
  system
}