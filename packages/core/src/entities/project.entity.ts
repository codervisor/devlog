/**
 * Project Entity for database storage
 *
 * Simplified compared to WorkspaceEntity - no per-project storage configuration.
 * All projects share the same centralized database configuration.
 */

import 'reflect-metadata';
import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn } from 'typeorm';
import type { ProjectMetadata, ProjectSettings } from '../types/index.js';
import { JsonColumn, TimestampColumn, getTimestampType } from './decorators.js';

@Entity('devlog_projects')
export class ProjectEntity {
  @PrimaryGeneratedColumn()
  id!: number;

  @Column({ type: 'varchar', length: 255 })
  name!: string;

  @Column({ type: 'text', nullable: true })
  description?: string;

  @Column({ type: 'varchar', length: 500, nullable: true })
  repositoryUrl?: string;

  @JsonColumn({ nullable: true })
  settings?: ProjectSettings;

  @CreateDateColumn({
    type: getTimestampType(),
    name: 'created_at',
  })
  createdAt!: Date;

  @TimestampColumn({ name: 'last_accessed_at' })
  lastAccessedAt!: Date;

  /**
   * Convert entity to ProjectMetadata type
   */
  toProjectMetadata(): ProjectMetadata {
    return {
      id: this.id,
      name: this.name,
      description: this.description,
      repositoryUrl: this.repositoryUrl,
      settings: this.settings || {},
      createdAt: this.createdAt,
      lastAccessedAt: this.lastAccessedAt,
    };
  }

  /**
   * Create entity from ProjectMetadata
   */
  static fromProjectData(
    project: Omit<ProjectMetadata, 'id' | 'createdAt' | 'lastAccessedAt'>,
  ): ProjectEntity {
    const entity = new ProjectEntity();
    // id will be auto-generated by the database
    entity.name = project.name;
    entity.description = project.description;
    entity.repositoryUrl = project.repositoryUrl;
    entity.settings = project.settings;
    entity.lastAccessedAt = new Date();
    return entity;
  }

  /**
   * Update entity with partial project data
   */
  updateFromProjectData(updates: Partial<ProjectMetadata>): void {
    if (updates.name !== undefined) this.name = updates.name;
    if (updates.description !== undefined) this.description = updates.description;
    if (updates.repositoryUrl !== undefined) this.repositoryUrl = updates.repositoryUrl;
    if (updates.settings !== undefined) this.settings = updates.settings;
    this.lastAccessedAt = new Date();
  }
}
