{
  "id": 266,
  "key": "architecture-refactor-mcp-as-api-client-layer-inst",
  "title": "Architecture Refactor: MCP as API Client Layer Instead of Direct Core Access",
  "type": "refactor",
  "description": "Redesign @devlog/mcp architecture to communicate through @devlog/web API endpoints instead of directly accessing @devlog/core services. This treats MCP as an AI agent interface layer similar to the web UI, creating proper architectural layering and separation of concerns.",
  "status": "in-progress",
  "priority": "high",
  "createdAt": "2025-07-24T06:37:47.574Z",
  "updatedAt": "2025-07-24T06:41:22.267Z",
  "notes": [
    {
      "id": "35f6ae7e-b844-4518-8966-020eed29268e",
      "timestamp": "2025-07-24T06:38:31.377Z",
      "category": "progress",
      "content": "**Analysis Complete - Architecture Issue Identified**\n\nCurrent architecture violates layering principles:\n```\n┌─────────────────────────────────────────────────────────────┐\n│                 CURRENT (PROBLEMATIC)                      │\n├─────────────────────────────────────────────────────────────┤\n│ AI Agents (Claude/Copilot/etc)                            │\n│     ↓ (direct MCP protocol)                               │\n│ @devlog/mcp ←──────── DIRECT IMPORT ──────→ @devlog/core  │\n│     ↓ (shares storage access)                              │\n│ @devlog/web ←──────── DIRECT IMPORT ──────→ @devlog/core  │\n│     ↓ (user interface)                                     │\n│ Human Users                                                │\n└─────────────────────────────────────────────────────────────┘\n```\n\n**Problems Identified:**\n1. **Direct core access:** MCP bypasses web API layer entirely\n2. **Shared storage state:** Both MCP and web access same storage directly\n3. **Tight coupling:** MCP depends on core implementation details\n4. **Inconsistent interface:** AI agents and humans use different access patterns\n5. **Single point of failure:** No centralized business logic enforcement"
    },
    {
      "id": "d5163cce-fd03-42a3-95c1-2af81c9c85b0",
      "timestamp": "2025-07-24T06:38:45.662Z",
      "category": "solution",
      "content": "**Target Architecture Design - API-First Layering**\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│                 TARGET (PROPER LAYERING)                   │\n├─────────────────────────────────────────────────────────────┤\n│ AI Agents (Claude/Copilot/etc)    Human Users             │\n│     ↓ (MCP protocol)                  ↓ (HTTP requests)   │\n│ ┌─────────────────┐              ┌─────────────────────┐   │\n│ │  @devlog/mcp    │              │   Next.js Web UI    │   │\n│ │   (AI Interface)│              │   (Human Interface)  │   │\n│ └─────────────────┘              └─────────────────────┘   │\n│     ↓ (HTTP API calls)                 ↓ (HTTP API calls) │\n│ ┌─────────────────────────────────────────────────────────┐ │\n│ │              @devlog/web                                │ │\n│ │          (Unified API Layer)                            │ │\n│ │  - REST endpoints                                       │ │\n│ │  - Business logic enforcement                           │ │\n│ │  - Authentication & authorization                       │ │\n│ │  - Request validation                                   │ │\n│ │  - Response formatting                                  │ │\n│ └─────────────────────────────────────────────────────────┘ │\n│     ↓ (internal imports only)                             │\n│ ┌─────────────────────────────────────────────────────────┐ │\n│ │              @devlog/core                               │ │\n│ │          (Business Logic Layer)                         │ │\n│ │  - WorkspaceDevlogManager                              │ │\n│ │  - Storage providers                                    │ │\n│ │  - Domain models                                       │ │\n│ └─────────────────────────────────────────────────────────┘ │\n└─────────────────────────────────────────────────────────────┘\n```\n\n**Key Benefits:**\n1. **Single API surface:** All external access goes through web API\n2. **Consistent interfaces:** Both AI and human users use same endpoints\n3. **Centralized validation:** Business rules enforced in one place\n4. **Better security:** Authentication/authorization at API layer\n5. **Easier monitoring:** All operations visible through HTTP logs\n6. **Decoupled components:** MCP becomes pure HTTP client"
    },
    {
      "id": "c4273224-08fb-4cd4-89fb-bdeae5fea693",
      "timestamp": "2025-07-24T06:39:01.305Z",
      "category": "progress",
      "content": "**Implementation Plan - Step-by-Step Migration**\n\n**Phase 1: HTTP Client Infrastructure (packages/mcp)**\n1. **Create API client**: `src/api/devlog-api-client.ts`\n   - HTTP client with proper error handling\n   - Workspace-aware request/response patterns\n   - Retry logic and timeout handling\n   - Type-safe request/response interfaces\n\n2. **Update MCP adapter**: `src/mcp-adapter.ts`\n   - Replace WorkspaceDevlogManager with API client\n   - Maintain same public interface for tools\n   - Handle HTTP errors -> MCP error mapping\n   - Session management for workspace context\n\n**Phase 2: Tool Migration (packages/mcp/src/tools)**\n1. **Core tools**: Update to use API client instead of direct manager calls\n2. **Workspace tools**: Adapt to HTTP-based workspace operations\n3. **Progress tools**: Update devlog updates through API endpoints\n4. **Search tools**: Use API search endpoints instead of direct storage\n\n**Phase 3: Error Handling & Response Mapping**\n1. **HTTP -> MCP error mapping**: Convert REST errors to MCP format\n2. **Response transformation**: Format API responses for MCP tools\n3. **Timeout handling**: Graceful degradation for slow API responses\n4. **Connection management**: Handle web service availability\n\n**Phase 4: Testing & Validation**\n1. **Integration tests**: Verify MCP tools work with API backend\n2. **Performance testing**: Ensure HTTP overhead is acceptable\n3. **Error scenario testing**: Network failures, API errors, timeouts\n4. **Compatibility verification**: All existing MCP functionality preserved\n\n**Dependencies:**\n- Web service must be running for MCP to function\n- Need to handle web service discovery/configuration\n- Consider local vs remote API endpoint scenarios"
    },
    {
      "id": "4449c03b-629e-4b21-bfcb-ad886821020d",
      "timestamp": "2025-07-24T06:41:22.267Z",
      "category": "progress",
      "content": "**Phase 1 Complete - HTTP Client Infrastructure Implemented**\n\nCreated two key components:\n\n1. **`DevlogApiClient`** (`packages/mcp/src/api/devlog-api-client.ts`):\n   - ✅ HTTP client with proper error handling and retries\n   - ✅ Workspace-aware request/response patterns  \n   - ✅ Type-safe interfaces matching core types\n   - ✅ Timeout and connection management\n   - ✅ Complete API coverage (CRUD, batch, search, stats)\n\n2. **`MCPApiAdapter`** (`packages/mcp/src/mcp-api-adapter.ts`):\n   - ✅ Drop-in replacement for MCPDevlogAdapter\n   - ✅ Same public interface for tool compatibility\n   - ✅ Proper HTTP error -> MCP error mapping\n   - ✅ Workspace session management\n   - ✅ Connection testing and health checks\n\n**Technical Details:**\n- Uses fetch API with AbortController for timeouts\n- Automatic retry logic for transient failures\n- Comprehensive error handling and user-friendly messages\n- Workspace-scoped API calls throughout\n- JSON-based request/response handling\n\n**Next Phase:** Update individual tool implementations to use new adapter"
    }
  ],
  "files": [],
  "relatedDevlogs": [],
  "context": {
    "businessContext": "Improves architectural consistency and maintainability by establishing clear layer boundaries. Web API becomes the single source of truth for all external access to devlog functionality, whether from human users or AI agents. This reduces coupling and enables better security, monitoring, and versioning.",
    "technicalContext": "Currently @devlog/mcp directly imports and uses WorkspaceDevlogManager and core services. Should instead make HTTP requests to @devlog/web API endpoints. This requires: 1. HTTP client implementation in MCP 2. Authentication/session management 3. Error handling and response mapping 4. Workspace-aware API calls",
    "dependencies": [],
    "decisions": [],
    "acceptanceCriteria": [
      "MCP no longer directly imports @devlog/core",
      "All MCP operations use web API endpoints",
      "Proper error handling for HTTP communication",
      "Workspace-aware API client",
      "Performance equivalent to direct access",
      "All existing MCP functionality preserved"
    ],
    "risks": []
  },
  "aiContext": {
    "currentSummary": "",
    "keyInsights": [
      "Web API already has comprehensive workspace-scoped endpoints",
      "MCP adapter pattern can be preserved with HTTP client backend",
      "Need to handle authentication and session state",
      "Error mapping between HTTP responses and MCP responses"
    ],
    "openQuestions": [],
    "relatedPatterns": [
      "Web UI already uses API client pattern successfully",
      "Similar to how frontend frameworks consume REST APIs",
      "Standard HTTP client patterns with retry/timeout logic"
    ],
    "suggestedNextSteps": [],
    "lastAIUpdate": "2025-07-24T06:37:47.574Z",
    "contextVersion": 1
  }
}